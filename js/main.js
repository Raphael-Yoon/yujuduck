import{GameEngine}from"./gameEngine.js";import{GameRenderer}from"./renderer.js";import{GAME_STATES}from"./constants.js";document.addEventListener("DOMContentLoaded",async()=>{console.log("DOM fully loaded and parsed");const e=document.getElementById("game-canvas"),t=e.getContext("2d"),n=document.getElementById("coin-display"),o=document.getElementById("result-display"),a=document.getElementById("collection-container"),l=document.getElementById("beg-confirmation-buttons"),i=document.getElementById("left-button"),d=document.getElementById("right-button"),s=document.getElementById("drop-button"),c=document.getElementById("game-over-modal"),r=document.getElementById("collected-count"),g=document.getElementById("restart-game-btn"),m=document.getElementById("player-name-input"),u=document.getElementById("save-score-btn"),E=new GameEngine(e,t),b=new GameRenderer(e,t,E);firebase.initializeApp({databaseURL:"https://yujuduck-default-rtdb.firebaseio.com/"});const h=firebase.database();let y=!1;try{await E.initialize(),console.log("Game initialized successfully")}catch(e){console.error("Failed to initialize game:",e)}function f(){n.textContent=`üí∞ ${E.getCoins()}Ïõê`}function S(e,t=!1){o.textContent=e,o.style.color=t?"#4CAF50":"#D32F2F",o.style.backgroundColor=t?"#E8F5E9":"#FFEBEE"}function A(){setTimeout(()=>{S("")},3e3)}function D(){a.innerHTML="";E.getCollectedDolls().forEach(e=>{const t=E.dollManager.getDollById(e);if(t){const e=document.createElement("div");e.className="collection-item";const n=document.createElement("img");n.src=t.src,n.alt=t.name;const o=document.createElement("p");o.textContent=t.name,e.appendChild(n),e.appendChild(o),a.appendChild(e)}})}function G(e){E.getGameState()===GAME_STATES.READY&&("ArrowLeft"===e.key?E.moveClawLeft():"ArrowRight"===e.key?E.moveClawRight():" "===e.key&&E.getGameState()===GAME_STATES.READY&&(e.preventDefault(),v()))}function T(e){if(E.getGameState()!==GAME_STATES.READY)return;e.touches&&e.preventDefault();const t=C(e),n=E.getClaw();t.x>=n.x&&t.x<=n.x+n.width&&t.y>=n.y&&t.y<=n.y+n.height&&(y=!0)}function p(t){if(!y||E.getGameState()!==GAME_STATES.READY)return;t.touches&&t.preventDefault();const n=C(t),o=E.getClaw();o.x=Math.max(0,Math.min(e.width-o.width,n.x-o.width/2))}function M(e){y=!1}function C(t){const n=e.getBoundingClientRect();return t.touches&&t.touches.length>0?{x:t.touches[0].clientX-n.left,y:t.touches[0].clientY-n.top}:{x:t.clientX-n.left,y:t.clientY-n.top}}function v(){if(E.getGameState()!==GAME_STATES.READY)return;if(!E.canPlay())return void(E.hasBegged()?L():(l.style.display="block",E.setGameState(GAME_STATES.AWAITING_BEG_CONFIRMATION),S("ÎèàÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§! üí∞",!1)));E.deductCoins(),f(),S("");const e=E.getClaw();e.isClosed=!1,e.grabbedDoll=null,E.setGameState(GAME_STATES.DROPPING)}function I(e,t){return e.x<t.x+t.width&&e.x+e.width>t.x&&e.y<t.y+t.height&&e.y+e.height>t.y}function x(){E.addCoins(500),E.setBeggedForMoney(),l.style.display="none",f(),S("ÏóÑÎßàÍ∞Ä Ïö©ÎèàÏùÑ Ï£ºÏÖ®Ïñ¥Ïöî! +500Ïõê üíù",!0),A(),E.setGameState(GAME_STATES.READY)}function R(){l.style.display="none",L()}function L(){r.textContent=E.getCollectedDolls().size,c.style.display="flex"}function w(){E.reset(),f(),D(),S(""),l.style.display="none",c.style.display="none",m.value=""}function k(){const e=m.value.trim();if(!e)return void alert("Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");const t=E.getCollectedDolls().size;h.ref("rankings").push({name:e,score:t,timestamp:Date.now()}).then(()=>{alert("Ï†êÏàòÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!"),_(),w()}).catch(e=>{console.error("Error saving score:",e),alert("Ï†êÏàò Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.")})}function _(){const e=new Date,t=e.getDay(),n=0===t?6:t-1,o=new Date(e);o.setDate(e.getDate()-n),o.setHours(0,0,0,0);const a=o.getTime();h.ref("rankings").orderByChild("timestamp").startAt(a).once("value",e=>{const t=[];e.forEach(e=>{t.push(e.val())}),t.sort((e,t)=>t.score-e.score);!function(e){const t=document.querySelector("#ranking-table tbody");t.innerHTML="",e.forEach((e,n)=>{const o=document.createElement("tr");o.innerHTML=`\n                <td>${n+1}</td>\n                <td>${e.name}</td>\n                <td>${e.score}</td>\n            `,t.appendChild(o)})}(t.slice(0,10))})}!function(){s.addEventListener("click",v),i.addEventListener("click",()=>E.moveClawLeft()),d.addEventListener("click",()=>E.moveClawRight()),document.addEventListener("keydown",G),e.addEventListener("mousedown",T),e.addEventListener("mousemove",p),e.addEventListener("mouseup",M),e.addEventListener("touchstart",T),e.addEventListener("touchmove",p),e.addEventListener("touchend",M),g.addEventListener("click",w),u.addEventListener("click",k);const t=document.getElementById("confirm-beg-button"),n=document.getElementById("decline-beg-button");t&&t.addEventListener("click",x),n&&n.addEventListener("click",R)}(),f(),D(),_(),function t(){!function(){const t=E.getClaw(),n=E.getDolls(),o=E.getGameState();if(n.forEach(n=>{n.isFalling&&(n.y+=1.5*t.speed,n.y>=e.height-n.height&&(n.y=e.height-n.height,n.isFalling=!1))}),o===GAME_STATES.DROPPING){t.y+=t.speed;let o=null;for(const e of n)if(!e.isGrabbed&&I(t,e)){o=e;break}o?(Math.random()<.7?(t.grabbedDoll=o,o.isGrabbed=!0):S(E.getRandomTauntMessage(),!1),t.isClosed=!0,E.setGameState(GAME_STATES.RAISING),t.grabbedDoll&&Math.random()<.25&&(t.isShaking=!0,S("ÏßëÍ≤åÍ∞Ä Ïã¨ÌïòÍ≤å ÌùîÎì§Î¶ΩÎãàÎã§!",!1))):t.y>=e.height-t.height&&(t.isClosed=!0,E.setGameState(GAME_STATES.RAISING),S(E.getRandomTauntMessage(),!1))}else if(o===GAME_STATES.RAISING){if(t.y-=t.speed,t.grabbedDoll){const e=t.isShaking?.025:.007;Math.random()<e?(S(E.getRandomTauntMessage(),!1),t.grabbedDoll.isGrabbed=!1,t.grabbedDoll.isFalling=!0,t.grabbedDoll=null,t.isShaking=!1):(t.grabbedDoll.x=t.x,t.grabbedDoll.y=t.y+t.height-20)}t.y<=50&&(t.isShaking=!1,E.setGameState(GAME_STATES.RETURNING))}else if(o===GAME_STATES.RETURNING){const e=50;t.x>e?t.x=Math.max(e,t.x-t.speed):t.x<e?t.x=Math.min(e,t.x+t.speed):(E.setGameState(GAME_STATES.RELEASING_DOLL),t.isClosed=!1),t.grabbedDoll&&(t.grabbedDoll.x=t.x)}else if(o===GAME_STATES.RELEASING_DOLL)if(t.grabbedDoll){if(t.grabbedDoll.y+=2*t.speed,t.grabbedDoll.y>e.height){const e=t.grabbedDoll.name;switch(t.grabbedDoll.type){case"bomb":S("Ìéë! Ìè≠ÌÉÑÏù¥ÏóàÏäµÎãàÎã§...",!1);break;case"coin":E.addCoins(500),S("Îèà Ïù∏Ìòï! +500Ïõê!",!0),E.getCollectedDolls().has(t.grabbedDoll.id)||(E.collectDoll(t.grabbedDoll.id),D());break;default:E.getCollectedDolls().has(t.grabbedDoll.id)?S(`Ïù¥ÎØ∏ Í∞ÄÏßÄÍ≥† ÏûàÎäî ${e}`,!1):(E.collectDoll(t.grabbedDoll.id),D(),S(E.getRandomCelebrationMessage(e),!0))}const o=n.indexOf(t.grabbedDoll);o>-1&&n.splice(o,1),t.grabbedDoll=null,f(),A(),E.setGameState(GAME_STATES.READY)}}else E.setGameState(GAME_STATES.READY),A()}(),b.render(),requestAnimationFrame(t)}()});