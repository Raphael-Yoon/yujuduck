document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded and parsed');
    
    // DOM ìš”ì†Œ ë° ìº”ë²„ìŠ¤ ì„¤ì •
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const coinDisplay = document.getElementById('coin-display');
    const resultDisplay = document.getElementById('result-display');
    const collectionContainer = document.getElementById('collection-container');
    const begConfirmationButtons = document.getElementById('beg-confirmation-buttons'); // New
    const leftButton = document.getElementById('left-button');
    const rightButton = document.getElementById('right-button');
    const dropButton = document.getElementById('drop-button');
    const gameOverModal = document.getElementById('game-over-modal');
    const collectedCountSpan = document.getElementById('collected-count');
    const restartGameBtn = document.getElementById('restart-game-btn');
    const playerNameInput = document.getElementById('player-name-input');
    const saveScoreBtn = document.getElementById('save-score-btn');
    

    // ê²Œì„ ì„¤ì •
    const prizeChuteX = -80;
    const prizeChuteWidth = 80;

    const tauntMessages = [
        'ë°”ë³´! ì¸í˜•ì´ ë„ë§ê°”ì–ì•„!',
        'ì—íœ´, ê·¸ê²ƒë„ ëª» ì¡ë‹ˆ?',
        'ë‹¤ìŒ ìƒì— ì¡ìœ¼ë ´!',
        'ëˆë§Œ ë‚ ë ¸ë„¤!',
        'ì—„ë§ˆí•œí…Œ ì¼ëŸ¬ë°”ì¹  ê±°ì•¼!',
        'ë„Œ ì¸í˜• ë½‘ê¸° ì†Œì§ˆ ì—†ì–´!',
        'ë‹¤ìŒì— ë˜ ë„ì „í•´ë´! (ê³¼ì—° ì¡ì„ ìˆ˜ ìˆì„ê¹Œ?)',
        'ì‹¤ë ¥ì´ ë¶€ì¡±í•˜ë„¤!',
        'ì•¼ ì´ ë˜¥ë©ì²­ì´ì•¼!!'
    ];

    const celebrationMessages = [
        'ì™€! ${dollName} íšë“!',
        'ëŒ€ë‹¨í•´ìš”! ${dollName}ì„(ë¥¼) ì¡ì•˜ì–´ìš”!',
        'ì»¬ë ‰ì…˜ì— ${dollName} ì¶”ê°€!',
        'ë‚˜ì´ìŠ¤ ìºì¹˜! ${dollName}!'
    ];

    // ì¸í˜• ë°ì´í„°
    const dollData = [
        { id: 1, name: 'ì¸í˜• 1í˜¸', rarity: 'Common', src: 'images/doll_01.png', type: 'normal' },
        { id: 2, name: 'ì¸í˜• 2í˜¸', rarity: 'Common', src: 'images/doll_02.png', type: 'normal' },
        { id: 3, name: 'ì¸í˜• 3í˜¸', rarity: 'Common', src: 'images/doll_03.png', type: 'normal' },
        { id: 4, name: 'ì¸í˜• 4í˜¸', rarity: 'Common', src: 'images/doll_04.png', type: 'normal' },
        { id: 5, name: 'ì¸í˜• 5í˜¸', rarity: 'Common', src: 'images/doll_05.png', type: 'normal' },
        { id: 6, name: 'ì¸í˜• 6í˜¸', rarity: 'Common', src: 'images/doll_06.png', type: 'normal' },
        { id: 7, name: 'ì¸í˜• 7í˜¸', rarity: 'Common', src: 'images/doll_07.png', type: 'normal' },
        { id: 8, name: 'ì¸í˜• 8í˜¸', rarity: 'Common', src: 'images/doll_08.png', type: 'normal' },
        { id: 9, name: 'ì¸í˜• 9í˜¸', rarity: 'Common', src: 'images/doll_09.png', type: 'normal' },
        { id: 10, name: 'ì¸í˜• 10í˜¸', rarity: 'Common', src: 'images/doll_10.png', type: 'normal' },
        { id: 11, name: 'ì¸í˜• 11í˜¸', rarity: 'Rare', src: 'images/doll_11.png', type: 'normal' },
        { id: 12, name: 'ì¸í˜• 12í˜¸', rarity: 'Rare', src: 'images/doll_12.png', type: 'normal' },
        { id: 13, name: 'ì¸í˜• 13í˜¸', rarity: 'Rare', src: 'images/doll_13.png', type: 'normal' },
        { id: 14, name: 'ì¸í˜• 14í˜¸', rarity: 'Rare', src: 'images/doll_14.png', type: 'normal' },
        { id: 15, name: 'ì¸í˜• 15í˜¸', rarity: 'Rare', src: 'images/doll_15.png', type: 'normal' },
        { id: 16, name: 'ì¸í˜• 16í˜¸', rarity: 'Rare', src: 'images/doll_16.png', type: 'normal' },
        { id: 17, name: 'ì¸í˜• 17í˜¸', rarity: 'Super Rare', src: 'images/doll_17.png', type: 'normal' },
        { id: 18, name: 'ì¸í˜• 18í˜¸', rarity: 'Super Rare', src: 'images/doll_18.png', type: 'normal' },
        { id: 19, name: 'í­íƒ„ ì¸í˜•', rarity: 'Super Rare', src: 'images/doll_19.png', type: 'bomb' },
        { id: 20, name: 'ëˆ ì¸í˜•', rarity: 'Super Rare', src: 'images/doll_20.png', type: 'coin' }
    ];

    // ê²Œì„ ìƒíƒœ
    let coins = 1000;
    const collectedDolls = new Set();
    let dolls = [];
    let images = {};
    let backgroundImg, clawOpenImg, clawClosedImg, prizeImg;
    let gameState = 'LOADING'; // LOADING, READY, MOVING, DROPPING, RAISING, RETURNING, RELEASING_DOLL, AWAITING_BEG_CONFIRMATION, COUNTDOWN
    let hasBeggedForMoney = false; // ì—„ë§ˆì—ê²Œ ëˆì„ ì¡°ë¥´ëŠ” ê¸°íšŒëŠ” 1íšŒë§Œ
    

    const claw = {
        x: canvas.width / 2,
        y: 50,
        width: 60,
        height: 60,
        speed: 3,
        isClosed: false,
        grabbedDoll: null,
        isShaking: false
    };

    // ì´ë¯¸ì§€ ë¡œë”©
    function loadImages(callback) {
        let loadedCount = 0;
        const totalCount = dollData.length + 4; // +2 for claw images, +1 for prize chute, +1 for background

        // Load background image
        backgroundImg = new Image();
        backgroundImg.src = 'images/background.jpg';
        backgroundImg.onload = () => {
            loadedCount++;
            if (loadedCount === totalCount) callback();
        }
        backgroundImg.onerror = () => {
            loadedCount++;
            console.error(`Could not load image: images/background.jpg`);
            if (loadedCount === totalCount) callback();
        }

        // Load doll images
        dollData.forEach(data => {
            const img = new Image();
            img.src = data.src;
            img.onload = () => {
                loadedCount++;
                images[data.src] = img;
                if (loadedCount === totalCount) {
                    callback();
                }
            };
            img.onerror = () => { // ì´ë¯¸ì§€ê°€ ì—†ì–´ë„ ê²Œì„ì´ ë©ˆì¶”ì§€ ì•Šë„ë¡
                loadedCount++;
                console.error(`Could not load image: ${data.src}`);
                if (loadedCount === totalCount) {
                    callback();
                }
            }
        });

        // Load claw images
        clawOpenImg = new Image();
        clawOpenImg.src = 'images/catch_o.png';
        clawOpenImg.onload = () => {
            loadedCount++;
            if (loadedCount === totalCount) callback();
        }
        clawOpenImg.onerror = () => {
            loadedCount++;
            console.error(`Could not load image: images/catch_o.png`);
            if (loadedCount === totalCount) callback();
        }

        clawClosedImg = new Image();
        clawClosedImg.src = 'images/catch_c.png';
        clawClosedImg.onload = () => {
            loadedCount++;
            if (loadedCount === totalCount) callback();
        }
        clawClosedImg.onerror = () => {
            loadedCount++;
            console.error(`Could not load image: images/catch_c.png`);
            if (loadedCount === totalCount) callback();
        }

        prizeImg = new Image();
        prizeImg.src = 'images/prize.png';
        prizeImg.onload = () => {
            loadedCount++;
            if (loadedCount === totalCount) callback();
        }
        prizeImg.onerror = () => {
            loadedCount++;
            console.error(`Could not load image: images/prize.png`);
            if (loadedCount === totalCount) callback();
        }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    function addEventListeners() {
        document.addEventListener('keydown', handleKeyDown);
        document.getElementById('drop-button').addEventListener('click', startPlay);
        
        // í™”ì‚´í‘œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('left-button').addEventListener('click', moveClawLeft);
        document.getElementById('right-button').addEventListener('click', moveClawRight);
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ë„ ì¶”ê°€
        document.getElementById('left-button').addEventListener('touchstart', function(e) {
            e.preventDefault();
            moveClawLeft();
        });
        document.getElementById('right-button').addEventListener('touchstart', function(e) {
            e.preventDefault();
            moveClawRight();
        });

        // ì—„ë§ˆì—ê²Œ ëˆ ì¡°ë¥´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('confirm-beg-button').addEventListener('click', confirmBegForMoney);
        document.getElementById('decline-beg-button').addEventListener('click', declineBegForMoney);
        
        restartGameBtn.addEventListener('click', restartGame);
        saveScoreBtn.addEventListener('click', handleSaveScore);

        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        canvas.addEventListener('mousedown', handleDragStart);
        canvas.addEventListener('mousemove', handleDragging);
        canvas.addEventListener('mouseup', handleDragEnd);
        canvas.addEventListener('mouseleave', handleDragEnd);

        // í„°ì¹˜ ì´ë²¤íŠ¸
        canvas.addEventListener('touchstart', handleDragStart);
        canvas.addEventListener('touchmove', handleDragging);
        canvas.addEventListener('touchend', handleDragEnd);
    }

    let isDragging = false;
    
    // í™”ì‚´í‘œ ë²„íŠ¼ìœ¼ë¡œ ì§‘ê²Œ ì´ë™
    function moveClawLeft() {
        if (gameState !== 'READY') return;
        claw.x = Math.max(0, claw.x - 20);
    }
    
    function moveClawRight() {
        if (gameState !== 'READY') return;
        claw.x = Math.min(canvas.width - claw.width, claw.x + 20);
    }

    function handleDragStart(e) {
        if (gameState !== 'READY') return;
        if (e.touches) e.preventDefault(); // í„°ì¹˜ ì´ë²¤íŠ¸ ê¸°ë³¸ ë™ì‘ ë°©ì§€
        const pos = getMousePos(e);
        // ì§‘ê²Œë¥¼ ì¡ì•˜ëŠ”ì§€ í™•ì¸
        if (pos.x >= claw.x && pos.x <= claw.x + claw.width &&
            pos.y >= claw.y && pos.y <= claw.y + claw.height) {
            isDragging = true;
        }
    }

    function handleDragging(e) {
        if (!isDragging || gameState !== 'READY') return;
        if (e.touches) e.preventDefault(); // í„°ì¹˜ ì´ë²¤íŠ¸ ê¸°ë³¸ ë™ì‘ ë°©ì§€
        const pos = getMousePos(e);
        claw.x = Math.max(0, Math.min(canvas.width - claw.width, pos.x - claw.width / 2));
    }

    function handleDragEnd(e) {
        isDragging = false;
    }

    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        // í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
        if (e.touches && e.touches.length > 0) {
            return {
                x: e.touches[0].clientX - rect.left,
                y: e.touches[0].clientY - rect.top
            };
        }
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }

    // ëª¨ë°”ì¼ ê¸°ê¸° ê°ì§€ í•¨ìˆ˜
    function isMobileDevice() {
        return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('Mobi') !== -1);
    }

    // ì¸í˜• ìƒì„± ë° ë°°ì¹˜
    function createDolls() {
        dolls = [];
        const prizeChuteRect = { x: prizeChuteX, y: canvas.height - 200, width: 300, height: 200 };
        for (let i = 0; i < 15; i++) {
            const data = dollData[Math.floor(Math.random() * dollData.length)];
            let newDoll;
            do {
                newDoll = {
                    x: Math.random() * (canvas.width - 150) + 100, // ë°”ë‹¥ì— ë¬´ì‘ìœ„ë¡œ
                    y: canvas.height - (Math.random() * 100 + 40),
                    width: 60,
                    height: 60,
                    isGrabbed: false,
                    isFalling: false,
                    ...data
                };
            } while (checkCollision(newDoll, prizeChuteRect));
            dolls.push(newDoll);
        }
    }

    // í‚¤ë³´ë“œ ì…ë ¥ ì²˜ë¦¬
    function handleKeyDown(e) {
        console.log('handleKeyDown - gameState:', gameState, 'key:', e.key);
        if (gameState !== 'READY') return;

        if (e.key === 'ArrowLeft') {
            claw.x = Math.max(0, claw.x - claw.speed);
        } else if (e.key === 'ArrowRight') {
            claw.x = Math.min(canvas.width - claw.width, claw.x + claw.speed);
        } else if (e.key === ' ' && gameState === 'READY') { // ìŠ¤í˜ì´ìŠ¤ë°”
            e.preventDefault();
            startPlay();
        }
    }

    function startPlay() {
        if (gameState !== 'READY') return;

        if (coins < 100) {
            if (!hasBeggedForMoney) {
                gameState = 'AWAITING_BEG_CONFIRMATION';
                resultDisplay.textContent = 'ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ğŸ’°';
            } else {
                // ê²Œì„ ì¢…ë£Œ - ì´ë¦„ ì…ë ¥ë°›ê¸°
                showGameOver();
            }
            return;
        }

        coins -= 100;
        coinDisplay.textContent = `${coins}ì›`;
        
        // ëˆì´ ë¶€ì¡±í•´ì§€ë©´ ë²„íŠ¼ì„ ì°¬ìŠ¤ë¡œ ë³€ê²½ (ì²« ë²ˆì§¸ë§Œ)
        if (coins < 100 && !hasBeggedForMoney) {
            dropButton.textContent = 'ì°¬ìŠ¤!!!';
        }
        
        resultDisplay.textContent = '';
        gameState = 'DROPPING';
        claw.isClosed = false;
        claw.grabbedDoll = null;
    }

    // ì—„ë§ˆì—ê²Œ ëˆ ì¡°ë¥´ê¸° í™•ì¸ í•¨ìˆ˜
    function confirmBegForMoney() {
        if (gameState !== 'AWAITING_BEG_CONFIRMATION') return;

        hasBeggedForMoney = true; // ê¸°íšŒ ì‚¬ìš©
        gameState = 'COUNTDOWN';
        begConfirmationButtons.style.display = 'none'; // ì˜ˆ/ì•„ë‹ˆì˜¤ ë²„íŠ¼ ìˆ¨ê¸°ê¸°

        let count = 3;
        resultDisplay.textContent = count;

        const countdownInterval = setInterval(() => {
            count--;
            if (count > 0) {
                resultDisplay.textContent = count;
            } else {
                clearInterval(countdownInterval);
                if (Math.random() < 0.6) { // 60% í™•ë¥ ë¡œ ëˆì„ ì¤Œ
                    const moneyGiven = (Math.floor(Math.random() * 10) + 1) * 100; // 100ì›ì—ì„œ 1000ì› ì‚¬ì´ (100ì› ë‹¨ìœ„)
                    coins += moneyGiven;
                    coinDisplay.textContent = `${coins}ì›`;
                    resultDisplay.textContent = `ì—„ë§ˆê°€ ëˆì„ ì£¼ì…¨ì–´ìš”! +${moneyGiven}ì›!`;
                } else {
                    resultDisplay.textContent = 'ì—„ë§ˆê°€ ëˆì„ ì•ˆ ì£¼ì…¨ì–´ìš”...';
                }
                setTimeout(() => {
                    gameState = 'READY'; // ìƒíƒœë¥¼ READYë¡œ ë˜ëŒë¦¼
                    dropButton.textContent = 'ë‚´ë ¤ê°€ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µì›
                }, 1000); // Show message for 1 second
            }
        }, 1000);
    }

    // ì—„ë§ˆì—ê²Œ ëˆ ì¡°ë¥´ê¸° ê±°ì ˆ í•¨ìˆ˜
    function declineBegForMoney() {
        if (gameState !== 'AWAITING_BEG_CONFIRMATION') return;

        hasBeggedForMoney = true; // ê¸°íšŒ ì‚¬ìš© (ê±°ì ˆí–ˆì–´ë„ ê¸°íšŒëŠ” ì†Œì§„)
        resultDisplay.textContent = 'ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!';
        gameState = 'READY'; // ìƒíƒœë¥¼ READYë¡œ ë˜ëŒë¦¼
        begConfirmationButtons.style.display = 'none'; // ì˜ˆ/ì•„ë‹ˆì˜¤ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        dropButton.textContent = 'ê²Œì„ ë'; // ëˆì´ ì—†ì–´ì„œ ê²Œì„ì´ ëë‚œ ìƒíƒœ
    }

    // ê²Œì„ ë£¨í”„
    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function update() {
        console.log('UPDATE - Current gameState:', gameState); // Debug log
        updateUIForGameState(); // UI ê°€ì‹œì„± ì—…ë°ì´íŠ¸

        // ë–¨ì–´ì§€ëŠ” ì¸í˜• ì²˜ë¦¬
        dolls.forEach(doll => {
            if (doll.isFalling) {
                doll.y += claw.speed * 1.5; // ì¤‘ë ¥ íš¨ê³¼
                // ë°”ë‹¥ ë˜ëŠ” ë‹¤ë¥¸ ì¸í˜•ê³¼ ë‹¿ìœ¼ë©´ ë©ˆì¶¤ (ê°„ë‹¨í•˜ê²Œ ë°”ë‹¥ìœ¼ë¡œ ì²˜ë¦¬)
                if (doll.y >= canvas.height - doll.height) {
                    doll.y = canvas.height - doll.height;
                    doll.isFalling = false;
                }
            }
        });

        if (gameState === 'DROPPING') {
            console.log('DEBUG: Entering DROPPING state. claw.y:', claw.y); // Debug log
            claw.y += claw.speed;

            let hitDoll = null;
            for (const doll of dolls) {
                if (!doll.isGrabbed && checkCollision(claw, doll)) {
                    hitDoll = doll;
                    console.log('DEBUG: Collision detected with doll:', doll.name); // Debug log
                    break;
                }
            }

            console.log('DEBUG: hitDoll is:', hitDoll ? hitDoll.name : 'null', 'claw.y:', claw.y, 'bottom threshold:', canvas.height - claw.height); // Debug log

            if (hitDoll) {
                // ì¡ê¸° í™•ë¥ 
                if (Math.random() < 0.7) { // 70% í™•ë¥ 
                    claw.grabbedDoll = hitDoll;
                    hitDoll.isGrabbed = true;
                    console.log('DEBUG: Doll grabbed successfully.'); // Debug log
                } else {
                    console.log('DEBUG: Failed to grab doll (50% chance). Displaying taunt.'); // Debug log
                    resultDisplay.textContent = tauntMessages[Math.floor(Math.random() * tauntMessages.length)]; // Taunt here
                }
                claw.isClosed = true;
                gameState = 'RAISING';

                // í”ë“¤ë¦¼ ì´ë²¤íŠ¸ ë°œë™ (25% í™•ë¥ )
                if (claw.grabbedDoll && Math.random() < 0.25) {
                    claw.isShaking = true;
                    resultDisplay.textContent = 'ì§‘ê²Œê°€ ì‹¬í•˜ê²Œ í”ë“¤ë¦½ë‹ˆë‹¤!';
                    console.log('DEBUG: Claw shaking activated.'); // Debug log
                }
            } else if (claw.y >= canvas.height - claw.height) { // ë°”ë‹¥ì— ë„ë‹¬í–ˆì§€ë§Œ ì¸í˜•ì„ ì¡ì§€ ëª»í•¨
                console.log('DEBUG: Claw hit bottom empty-handed. Displaying taunt.'); // Debug log
                claw.isClosed = true; // ì§‘ê²Œ ë‹«ê¸° (ë¹ˆì†)
                gameState = 'RAISING';
                resultDisplay.textContent = tauntMessages[Math.floor(Math.random() * tauntMessages.length)];
            }
        } else if (gameState === 'RAISING') {
            console.log('DEBUG: Entering RAISING state.'); // Debug log
            claw.y -= claw.speed;
            if (claw.grabbedDoll) {
                // í”ë“¤ë¦´ ë•Œ ë†“ì¹  í™•ë¥  ì¦ê°€ (2.5%), í‰ì†Œì—ëŠ” (0.7%)
                const dropChance = claw.isShaking ? 0.025 : 0.007;
                if (Math.random() < dropChance) {
                    console.log('DEBUG: Doll dropped while raising. Displaying taunt.'); // Debug log
                    resultDisplay.textContent = tauntMessages[Math.floor(Math.random() * tauntMessages.length)];
                    claw.grabbedDoll.isGrabbed = false;
                    claw.grabbedDoll.isFalling = true;
                    claw.grabbedDoll = null;
                    claw.isShaking = false; // í”ë“¤ë¦¼ ë©ˆì¶¤
                } else {
                    claw.grabbedDoll.x = claw.x;
                    claw.grabbedDoll.y = claw.y + claw.height - 20; // Adjust overlap
                }
            }
            if (claw.y <= 50) {
                claw.isShaking = false; // ì˜¬ë¼ê°€ë©´ í”ë“¤ë¦¼ ë©ˆì¶¤
                gameState = 'RETURNING';
            }
        } else if (gameState === 'RETURNING') {
            console.log('DEBUG: Entering RETURNING state.'); // Debug log
            const targetX = 50;
            // ìˆ˜í‰ ì´ë™
            if (claw.x > targetX) {
                claw.x = Math.max(targetX, claw.x - claw.speed);
            } else if (claw.x < targetX) {
                claw.x = Math.min(targetX, claw.x + claw.speed);
            } else { // ëª©í‘œ ìœ„ì¹˜ ë„ì°©
                gameState = 'RELEASING_DOLL';
                claw.isClosed = false; // ì§‘ê²Œ ì—´ê¸°
            }

            // ì¸í˜•ë„ ê°™ì´ ì´ë™
            if (claw.grabbedDoll) {
                claw.grabbedDoll.x = claw.x;
            }
        }
        else if (gameState === 'RELEASING_DOLL') {
            console.log('DEBUG: Entering RELEASING_DOLL state.'); // Debug log
            if (claw.grabbedDoll) {
                // ì¸í˜•ì´ ë–¨ì–´ì§€ëŠ” íš¨ê³¼
                claw.grabbedDoll.y += claw.speed * 2;
                if (claw.grabbedDoll.y > canvas.height) {
                    // ì¸í˜• íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ê²°ê³¼ ì²˜ë¦¬
                    switch (claw.grabbedDoll.type) {
                        case 'bomb':
                            resultDisplay.textContent = 'í‘! í­íƒ„ì´ì—ˆìŠµë‹ˆë‹¤...';
                            break;
                        case 'coin':
                            coins += 500;
                            coinDisplay.textContent = `${coins}ì›`;
                            resultDisplay.textContent = `ëˆ ì¸í˜•! +500ì›!`;
                            if (!collectedDolls.has(claw.grabbedDoll.id)) {
                                collectedDolls.add(claw.grabbedDoll.id);
                                updateCollectionDisplay();
                            }
                            break;
                        default: // normal
                            const messageTemplate = celebrationMessages[Math.floor(Math.random() * celebrationMessages.length)];
                            resultDisplay.textContent = messageTemplate.replace('${dollName}', claw.grabbedDoll.name);
                            
                            if (!collectedDolls.has(claw.grabbedDoll.id)) {
                                collectedDolls.add(claw.grabbedDoll.id);
                                updateCollectionDisplay();
                            }
                            break;
                    }
                    
                    // ì¡íŒ ì¸í˜•ì€ í™”ë©´ì—ì„œ ì œê±°
                    dolls = dolls.filter(d => d !== claw.grabbedDoll);
                    claw.grabbedDoll = null;
                    
                    // ê²Œì„ ì¢…ë£Œ ì¡°ê±´ í™•ì¸ (ëˆ ë¶€ì¡±í•˜ê³  ì—„ë§ˆì—ê²Œ ì¡°ë¥¼ ê¸°íšŒë„ ì—†ìŒ)
                    if (coins < 100 && hasBeggedForMoney) {
                        showGameOver();
                        return;
                    }
                    
                    // ì„ì‹œ: í…ŒìŠ¤íŠ¸ìš© ê²Œì„ ì¢…ë£Œ (ìˆ˜ì§‘í•œ ì¸í˜•ì´ 5ê°œ ì´ìƒì¼ ë•Œ)
                    // if (collectedDolls.size >= 5) {
                    //     showGameOver();
                    //     return;
                    // }
                    
                    // ìƒíƒœ ë¦¬ì…‹
                    resetClaw();
                }
            } else {
                // ì¡ì€ ì¸í˜•ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ë¦¬ì…‹
                resetClaw();
            }
        }
    }

    // ì§‘ê²Œ ì´ˆê¸°í™” í•¨ìˆ˜
    function resetClaw() {
        claw.x = canvas.width / 2;
        claw.y = 50;
        claw.isClosed = false;
        claw.grabbedDoll = null;
        claw.isShaking = false; // í”ë“¤ë¦¼ ìƒíƒœ ì´ˆê¸°í™”
        gameState = 'READY';
    }

    // UI ìš”ì†Œ ê°€ì‹œì„± ì—…ë°ì´íŠ¸
    function updateUIForGameState() {
        // ì—„ë§ˆì—ê²Œ ëˆ ì¡°ë¥´ê¸° ë²„íŠ¼ ê°€ì‹œì„±
        if (gameState === 'AWAITING_BEG_CONFIRMATION') {
            begConfirmationButtons.style.display = 'block';
        } else {
            begConfirmationButtons.style.display = 'none';
        }

        // ê²Œì„ í”Œë ˆì´ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        const enableButtons = (gameState === 'READY');
        leftButton.disabled = !enableButtons;
        rightButton.disabled = !enableButtons;
        dropButton.disabled = !enableButtons;
    }

    // ê·¸ë¦¬ê¸°
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw background image
        if (backgroundImg && backgroundImg.complete) {
            ctx.drawImage(backgroundImg, 0, 0, canvas.width, canvas.height);
        }

        // ì¸í˜• ê·¸ë¦¬ê¸°
        dolls.forEach(doll => {
            const img = images[doll.src];
            if (img) {
                ctx.drawImage(img, doll.x, doll.y, doll.width, doll.height);
            } else { // ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°
                ctx.fillStyle = '#ff00ff'; // ëˆˆì— ë„ëŠ” ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                ctx.fillRect(doll.x, doll.y, doll.width, doll.height);
            }
        });

        // ìƒí’ˆ ë°°ì¶œêµ¬
        if (prizeImg && prizeImg.complete) {
            ctx.drawImage(prizeImg, prizeChuteX, canvas.height - 200, 300, 200);
        } else {
            ctx.fillStyle = '#a0a0a0';
            ctx.fillRect(prizeChuteX, canvas.height - 50, prizeChuteWidth, 50);
            ctx.fillStyle = '#c0c0c0';
            ctx.fillRect(prizeChuteX, canvas.height - 50, prizeChuteWidth, 10);
        }

        // ì§‘ê²Œ ê·¸ë¦¬ê¸°
        drawClaw();
    }

    function drawClaw() {
        let drawX = claw.x;
        if (claw.isShaking) {
            drawX += (Math.random() - 0.5) * 10; // ì¢Œìš°ë¡œ 5px ë²”ìœ„ ë‚´ì—ì„œ í”ë“¤ë¦¼
        }

        // Draw the line
        ctx.beginPath();
        ctx.moveTo(drawX + claw.width / 2, 0);
        ctx.lineTo(drawX + claw.width / 2, claw.y);
        ctx.strokeStyle = '#777';
        ctx.lineWidth = 2;
        ctx.stroke();

        const img = claw.isClosed ? clawClosedImg : clawOpenImg;
        if (img && img.complete) {
            ctx.drawImage(img, drawX, claw.y, claw.width, claw.height);
        } else {
            // Fallback drawing if image is not loaded
            ctx.fillStyle = '#999';
            ctx.fillRect(drawX, claw.y, claw.width, claw.height);
        }
    }

    function checkCollision(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + rect1.height > rect2.y;
    }

    // ê²Œì„ ì˜¤ë²„ í‘œì‹œ
    function showGameOver() {
        gameState = 'GAME_OVER';
        collectedCountSpan.textContent = collectedDolls.size;
        playerNameInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        gameOverModal.style.display = 'block';
        dropButton.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
        dropButton.textContent = 'ê²Œì„ ë'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
        playerNameInput.focus(); // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    }

    // ì ìˆ˜ ì €ì¥ ì²˜ë¦¬
    function handleSaveScore() {
        const playerName = playerNameInput.value.trim();
        if (playerName === '') {
            alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            playerNameInput.focus();
            return;
        }
        saveScore(playerName, collectedDolls.size);
        saveScoreBtn.disabled = true; // ì €ì¥ í›„ ë²„íŠ¼ ë¹„í™œì„±í™”
        saveScoreBtn.textContent = 'ì €ì¥ë¨';
    }

    // ê²Œì„ ì¬ì‹œì‘
    function restartGame() {
        coins = 1000;
        hasBeggedForMoney = false;
        collectedDolls.clear();
        coinDisplay.textContent = `${coins}ì›`;
        resultDisplay.textContent = '';
        gameOverModal.style.display = 'none';
        saveScoreBtn.disabled = false; // ì ìˆ˜ ì €ì¥ ë²„íŠ¼ í™œì„±í™”
        saveScoreBtn.textContent = 'ì ìˆ˜ ì €ì¥'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        createDolls();
        updateCollectionDisplay();
        resetClaw();
        dropButton.disabled = false; // ë²„íŠ¼ í™œì„±í™”
        dropButton.textContent = 'ë‚´ë ¤ê°€ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    }


    // ì»¬ë ‰ì…˜ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateCollectionDisplay() {
        collectionContainer.innerHTML = '';
        dollData.forEach(data => {
            const item = document.createElement('div');
            item.classList.add('collection-item');

            const img = document.createElement('img');
            const name = document.createElement('p');
            
            if (collectedDolls.has(data.id)) {
                const loadedImg = images[data.src];
                if(loadedImg) img.src = loadedImg.src;
                name.textContent = data.name;
                item.style.backgroundColor = '#e0ffe0';
            } else {
                // ì•„ì§ ëª» ëª¨ì€ ì¸í˜•
                img.style.opacity = '0.2';
                const loadedImg = images[data.src];
                if(loadedImg) img.src = loadedImg.src;
                name.textContent = '???';
            }
            
            item.appendChild(img);
            item.appendChild(name);
            collectionContainer.appendChild(item);
        });
    }

    // ê²Œì„ ì‹œì‘
    loadImages(init);

    // Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyAwO92zAoXW3ujNoNfy4tOMzN8wZwwYQgg",
        authDomain: "yujuduck.firebaseapp.com",
        databaseURL: "https://yujuduck-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "yujuduck",
        storageBucket: "yujuduck.firebasestorage.app",
        messagingSenderId: "749402785241",
        appId: "1:749402785241:web:dbf5ce7b4dd4d808e185c8",
        measurementId: "G-HQMEJQM1ML"
    };

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ë­í‚¹ ê´€ë ¨ DOM ìš”ì†Œ
    const rankingTableBody = document.querySelector('#ranking-table tbody');
    const rankingTitle = document.getElementById('ranking-title');

    // ë­í‚¹ ë¡œë“œ ë° ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function loadRanking() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const monthKey = `${year}-${month}`;

        rankingTitle.textContent = `ë­í‚¹ (${year}ë…„ ${month}ì›”)`;

        const rankingRef = database.ref('ranking/' + monthKey);

        rankingRef.orderByChild('score').limitToLast(10).on('value', (snapshot) => {
            const ranking = [];
            snapshot.forEach((childSnapshot) => {
                ranking.push({
                    name: childSnapshot.key,
                    score: childSnapshot.val().score
                });
            });

            // ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            ranking.reverse();

            rankingTableBody.innerHTML = ''; // í…Œì´ë¸” ì´ˆê¸°í™”

            ranking.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${entry.name}</td>
                    <td>${entry.score}</td>
                `;
                rankingTableBody.appendChild(row);
            });
        });
    }

    // ì ìˆ˜ ì €ì¥ í•¨ìˆ˜ (Firebase)
    function saveScore(playerName, score) {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const monthKey = `${year}-${month}`;

        const playerRef = database.ref(`ranking/${monthKey}/${playerName}`);

        playerRef.once('value', (snapshot) => {
            if (snapshot.exists() && snapshot.val().score >= score) {
                alert('ê¸°ì¡´ ì ìˆ˜ë³´ë‹¤ ë‚®ì€ ì ìˆ˜ì…ë‹ˆë‹¤. ê°±ì‹ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            } else {
                playerRef.set({ score: score }, (error) => {
                    if (error) {
                        alert('ì ìˆ˜ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ì ìˆ˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }
                });
            }
        });
    }

    // ê²Œì„ ì´ˆê¸°í™” í•¨ìˆ˜
    function init() {
        // ëª¨ë°”ì¼ ê¸°ê¸°ì¸ ê²½ìš° ì§‘ê²Œ ì†ë„ ì¡°ì ˆ
        if (isMobileDevice()) {
            claw.speed = 3.5; // ëª¨ë°”ì¼ì—ì„œëŠ” ë” ë¹ ë¥´ê²Œ (ì˜ˆì‹œ ê°’)
        } else {
            claw.speed = 3; // ë°ìŠ¤í¬í†± ê¸°ë³¸ ì†ë„
        }

        createDolls();
        updateCollectionDisplay();
        addEventListeners();
        coinDisplay.textContent = `${coins}ì›`; // ì´ˆê¸° ëˆ í‘œì‹œ
        gameState = 'READY';
        loadRanking(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ë­í‚¹ í‘œì‹œ
        gameLoop();
    }
});
